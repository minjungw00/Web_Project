name: web_project-monitoring-dev

x-default-dns: &default-dns
  dns:
    - ${COMPOSE_DNS1:-1.1.1.1}
    - ${COMPOSE_DNS2:-8.8.8.8}

services:
  prometheus:
    <<: *default-dns
    image: prom/prometheus:latest
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-lifecycle
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - ${PROMETHEUS_DATA_MOUNT:-prometheus-data}:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      - node-exporter
      - cadvisor
      - nginx-exporter
      - mysqld-exporter
      - blackbox-exporter
      - telegraf
    networks:
      - webnet

  alertmanager:
    <<: *default-dns
    image: prom/alertmanager:latest
    entrypoint: /bin/sh
    command:
      - -ec
      - |
        set -eu
        tmp_file=$$(mktemp)
        awk '
          BEGIN {
            repl["$${ALERTMANAGER_SLACK_WEBHOOK_URL}"] = ENVIRON["ALERTMANAGER_SLACK_WEBHOOK_URL"]
            repl["$${ALERTMANAGER_SLACK_CHANNEL}"] = ENVIRON["ALERTMANAGER_SLACK_CHANNEL"]
            repl["$${ALERTMANAGER_EMAIL_TO}"] = ENVIRON["ALERTMANAGER_EMAIL_TO"]
            repl["$${ALERTMANAGER_SMTP_HOST}"] = ENVIRON["ALERTMANAGER_SMTP_HOST"]
            repl["$${ALERTMANAGER_SMTP_FROM}"] = ENVIRON["ALERTMANAGER_SMTP_FROM"]
            repl["$${ALERTMANAGER_SMTP_USERNAME}"] = ENVIRON["ALERTMANAGER_SMTP_USERNAME"]
            repl["$${ALERTMANAGER_SMTP_PASSWORD}"] = ENVIRON["ALERTMANAGER_SMTP_PASSWORD"]
          }
          {
            line = $0
            for (pattern in repl) {
              gsub(pattern, repl[pattern], line)
            }
            print line
          }
        ' /etc/alertmanager/config.yml > "$$tmp_file"
        exec /bin/alertmanager --config.file="$$tmp_file" --storage.path=/alertmanager
    environment:
      ALERTMANAGER_SLACK_WEBHOOK_URL: ${ALERTMANAGER_SLACK_WEBHOOK_URL:-}
      ALERTMANAGER_SLACK_CHANNEL: ${ALERTMANAGER_SLACK_CHANNEL:-#web-project-alerts}
      ALERTMANAGER_EMAIL_TO: ${ALERTMANAGER_EMAIL_TO:-ops@example.com}
      ALERTMANAGER_SMTP_HOST: ${ALERTMANAGER_SMTP_HOST:-smtp.example.com:587}
      ALERTMANAGER_SMTP_FROM: ${ALERTMANAGER_SMTP_FROM:-monitor@web-project.dev}
      ALERTMANAGER_SMTP_USERNAME: ${ALERTMANAGER_SMTP_USERNAME:-monitor}
      ALERTMANAGER_SMTP_PASSWORD: ${ALERTMANAGER_SMTP_PASSWORD:-change-me}
    volumes:
      - ./alertmanager/config.yml:/etc/alertmanager/config.yml:ro
      - ${ALERTMANAGER_DATA_MOUNT:-alertmanager-data}:/alertmanager
    ports:
      - "9093:9093"
    depends_on:
      - prometheus
    networks:
      - webnet

  grafana:
    <<: *default-dns
    image: grafana/grafana:latest
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_SERVER_ROOT_URL: "${GRAFANA_ROOT_URL:-http://localhost:8081/monitoring/grafana/}"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      GF_LOG_FILTERS: "router:debug"
      GF_USERS_DEFAULT_THEME: system
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /etc/grafana/provisioning/dashboards/node-exporter-full.json
    volumes:
      - ${GRAFANA_DATA_MOUNT:-grafana-data}:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki
    networks:
      - webnet

  loki:
    <<: *default-dns
    image: grafana/loki:latest
    command:
      - -config.file=/etc/loki/config.yml
    volumes:
      - ./loki/config.yml:/etc/loki/config.yml:ro
      - ${LOKI_DATA_MOUNT:-loki-data}:/loki
    ports:
      - "3100:3100"
    networks:
      - webnet

  promtail:
    <<: *default-dns
    image: grafana/promtail:latest
    command:
      - -config.file=/etc/promtail/config.yml
    volumes:
      - ./promtail/config.yml:/etc/promtail/config.yml:ro
      - ${PROMTAIL_POSITIONS_MOUNT:-promtail-positions}:/var/lib/promtail
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - webnet

  node-exporter:
    <<: *default-dns
    image: prom/node-exporter:latest
    command:
      - --path.rootfs=/rootfs
      - --path.procfs=/host/proc
      - --path.sysfs=/host/sys
      - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
      - --collector.filesystem.fs-types-exclude=^(sys|proc|autofs|cgroup|devpts|devtmpfs|nsfs|overlay|fuse.*|tmpfs|rpc_pipefs|mqueue)$$
      - --collector.processes
      - --collector.ethtool
      - --collector.systemd
      - --collector.interrupts
    pid: host
    cap_add:
      - NET_ADMIN
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
      - /run/systemd:/run/systemd:ro
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket:ro
    ports:
      - "9100:9100"
    networks:
      - webnet

  cadvisor:
    <<: *default-dns
    image: gcr.io/cadvisor/cadvisor:latest
    privileged: true
    devices:
      - /dev/kmsg:/dev/kmsg
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    ports:
      - "8080:8080"
    networks:
      - webnet

  nginx-exporter:
    <<: *default-dns
    image: nginx/nginx-prometheus-exporter:latest
    command:
      - -nginx.scrape-uri=${NGINX_EXPORTER_SCRAPE_URI:-http://nginx/nginx_status}
    ports:
      - "9113:9113"
    networks:
      - webnet

  mysqld-exporter:
    <<: *default-dns
    image: prom/mysqld-exporter:latest
    command:
      - --config.my-cnf=/etc/.mysqld_exporter.cnf
      - --mysqld.address=${MYSQL_EXPORTER_ADDRESS:-mysql:3306}
      - --collect.global_status
      - --collect.global_variables
      - --collect.info_schema.innodb_metrics
      - --collect.info_schema.processlist
      - --collect.info_schema.tables
      - --collect.info_schema.tablestats
      - --collect.info_schema.userstats
      - --collect.perf_schema.eventsstatements
      - --collect.perf_schema.eventsstatementssum
      - --collect.perf_schema.eventswaits
      - --collect.perf_schema.file_events
      - --collect.perf_schema.file_instances
      - --collect.perf_schema.indexiowaits
      - --collect.perf_schema.tableiowaits
      - --collect.perf_schema.tablelocks
    volumes:
      - ./mysqld-exporter/.my.cnf.dev:/etc/.mysqld_exporter.cnf:ro
    ports:
      - "9104:9104"
    networks:
      - webnet

  blackbox-exporter:
    <<: *default-dns
    image: prom/blackbox-exporter:latest
    ports:
      - "9115:9115"
    networks:
      - webnet

  telegraf:
    <<: *default-dns
    image: telegraf:latest
    environment:
      TELEGRAF_ENVIRONMENT: dev
      TELEGRAF_NGINX_STATUS_URL: ${TELEGRAF_NGINX_STATUS_URL:-http://nginx/nginx_status}
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ${NGINX_LOGS_MOUNT:-nginx-logs}:/var/log/nginx:ro
    ports:
      - "9273:9273"
    networks:
      - webnet

networks:
  webnet:
    name: ${APP_NETWORK_NAME:-web_project_webnet-dev}
    external: true
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
  loki-data:
  promtail-positions:
  alertmanager-data:
  nginx-logs:
    external: true
    name: web_project-dev_nginx-logs
