# syntax=docker/dockerfile:1.7
FROM eclipse-temurin:21-jdk

ARG USER_ID=1000
ARG GROUP_ID=1000

RUN set -eux; \
    if getent group "${GROUP_ID}" >/dev/null; then \
      existing_group=$(getent group "${GROUP_ID}" | cut -d: -f1); \
      if [ "${existing_group}" != "app" ]; then \
        groupmod -n app "${existing_group}"; \
      fi; \
    else \
      groupadd -g "${GROUP_ID}" app; \
    fi; \
    if getent passwd "${USER_ID}" >/dev/null; then \
      existing_user=$(getent passwd "${USER_ID}" | cut -d: -f1); \
      if [ "${existing_user}" != "app" ]; then \
        usermod -l app "${existing_user}"; \
        usermod -d /home/app -m app; \
      fi; \
      usermod -g app app; \
    elif id -u app >/dev/null 2>&1; then \
      usermod -u "${USER_ID}" -g app app; \
    else \
      useradd -m -u "${USER_ID}" -g app app; \
    fi

WORKDIR /workspace

# Copy Gradle wrapper and configuration for dependency caching.
COPY backend/gradlew ./
COPY backend/gradle ./gradle
COPY backend/build.gradle backend/settings.gradle ./

RUN chmod +x gradlew \
  && mkdir -p /workspace/.gradle \
  && chown -R app:app /workspace

COPY infra/application/docker/backend/dev-entrypoint.sh /usr/local/bin/dev-entrypoint.sh
RUN chmod +x /usr/local/bin/dev-entrypoint.sh

USER root

# Install curl for healthchecks
RUN set -eux; \
  apt-get update; \
  DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends curl; \
  rm -rf /var/lib/apt/lists/*

EXPOSE 8080

ENTRYPOINT ["/usr/local/bin/dev-entrypoint.sh"]
CMD ["./gradlew", "bootRun"]
